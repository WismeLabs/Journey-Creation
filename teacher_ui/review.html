<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Review - Journey Creation</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        nav {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        #globalStatus {
            background: #fef3c7;
            border-bottom: 1px solid #fbbf24;
            padding: 12px 24px;
            display: none;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 101;
        }

        #globalStatus.active { display: flex; }

        #globalStatus .status-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        #globalStatus .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #d97706;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #globalStatus .status-text {
            font-size: 14px;
            font-weight: 500;
            color: #92400e;
        }

        #globalStatus .status-dismiss {
            background: none;
            border: none;
            color: #92400e;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 18px;
            line-height: 1;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 24px;
        }

        .nav-brand {
            font-size: 18px;
            font-weight: 700;
            padding: 20px 0;
            margin-right: 40px;
        }

        .nav-links {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            padding: 20px 16px;
            color: var(--gray-600);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-link:hover { color: var(--primary); }
        .nav-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        .page-header {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .chapter-meta {
            display: flex;
            gap: 24px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .chapter-meta span {
            color: var(--gray-600);
            font-size: 14px;
        }

        .chapter-meta strong {
            color: var(--gray-900);
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-600);
            color: white;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-500);
            font-size: 18px;
        }

        .content-section {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .content-section h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray-200);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
        }

        .concepts-table {
            width: 100%;
            border-collapse: collapse;
        }

        .concepts-table th {
            background: var(--gray-100);
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-300);
        }

        .concepts-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 14px;
        }

        .concepts-table tbody tr:hover {
            background: var(--gray-50);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-easy { background: #d1fae5; color: #065f46; }
        .badge-medium { background: #fed7aa; color: #92400e; }
        .badge-hard { background: #fecaca; color: #991b1b; }

        .badge-definition { background: #dbeafe; color: #1e40af; }
        .badge-process { background: #e0e7ff; color: #3730a3; }
        .badge-formula { background: #fce7f3; color: #831843; }
        .badge-example { background: #d1fae5; color: #065f46; }
        .badge-application { background: #fef3c7; color: #92400e; }

        /* Chapter Analysis Styles */
        .analysis-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            padding: 20px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .analysis-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .analysis-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .analysis-value {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .confidence-bar {
            display: inline-block;
            width: 120px;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            vertical-align: middle;
            margin-right: 8px;
        }

        .confidence-fill {
            display: block;
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        .analysis-details {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 16px;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-section strong {
            display: block;
            color: var(--primary-dark);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-section p {
            margin: 0;
            color: #374151;
            line-height: 1.6;
            font-size: 14px;
        }

        .badge-overview_introduction { background: #dbeafe; color: #1e40af; }
        .badge-topic_deepdive { background: #fce7f3; color: #831843; }
        .badge-review_consolidation { background: #d1fae5; color: #065f46; }
        .badge-mixed { background: #fed7aa; color: #92400e; }

        .importance-bar {
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .importance-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray-300);
        }

        .importance-dot.filled {
            background: var(--primary);
        }

        .episode-plan-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .episode-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-300);
        }

        .episode-plan-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .episode-duration {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            background: white;
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid var(--gray-200);
        }

        .episode-concepts-list {
            margin: 12px 0;
        }

        .concept-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
        }

        .concept-item-name {
            flex: 1;
            font-weight: 500;
        }

        .concept-item-meta {
            display: flex;
            gap: 8px;
            font-size: 12px;
        }

        .episode-rationale {
            background: white;
            border-left: 3px solid var(--primary);
            padding: 12px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--gray-600);
            font-style: italic;
        }

        .script-card {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .script-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .script-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            color: var(--gray-600);
        }

        .script-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .script-meta-item strong {
            color: var(--gray-900);
        }

        .validation-status {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .validation-passed {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .validation-failed {
            background: #fecaca;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .validation-warnings {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .validation-errors {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
        }

        .validation-errors ul {
            margin: 8px 0 0 20px;
            color: #991b1b;
        }

        .script-content {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Georgia', serif;
            line-height: 1.8;
            font-size: 15px;
        }

        .script-section {
            margin-bottom: 20px;
        }

        .script-speaker {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .script-text {
            color: var(--gray-800);
        }

        /* Workflow Stage Indicator */
        .workflow-stages {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .workflow-stages h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .stage-flow {
            display: flex;
            align-items: center;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .stage-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 24px;
            border-radius: 8px;
            background: var(--gray-100);
            color: var(--gray-600);
            min-width: 120px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            border: 2px solid transparent;
        }

        .stage-box.completed {
            background: #d1fae5;
            color: #065f46;
            border-color: var(--success);
        }

        .stage-box.active {
            background: #dbeafe;
            color: #1e40af;
            border-color: var(--primary);
            font-weight: 600;
        }

        .stage-box .icon {
            font-size: 24px;
        }

        .stage-connector {
            color: var(--gray-300);
            font-size: 20px;
            font-weight: bold;
        }

        .stage-connector.completed {
            color: var(--success);
        }

        /* Episode Status Cards */
        .episode-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .episode-status-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 16px;
        }

        .episode-status-card.pending {
            border-left: 4px solid var(--warning);
        }

        .episode-status-card.approved {
            border-left: 4px solid var(--success);
        }

        .episode-status-card.failed {
            border-left: 4px solid var(--danger);
        }

        .episode-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.generated {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.failed {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
    <script src="ui-state-manager.js"></script>
</head>
<body>
    <div id="globalStatus">
        <div class="status-content">
            <div class="spinner"></div>
            <span class="status-text" id="globalStatusText">Processing...</span>
        </div>
        <button class="status-dismiss" onclick="dismissGlobalStatus()">√ó</button>
    </div>

    <nav>
        <div class="nav-container">
            <div class="nav-brand">Journey Creation</div>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">‚Üê Back to Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Comprehensive Chapter Review</h1>
            <div class="chapter-meta">
                <span>Chapter ID: <strong id="chapterId">Loading...</strong></span>
                <span>Subject: <strong id="chapterSubject">Loading...</strong></span>
                <span>Grade: <strong id="chapterGrade">Loading...</strong></span>
                <span>Episodes: <strong id="episodeCount">Loading...</strong></span>
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="loadChapter()">Refresh</button>
            </div>
        </div>

        <div id="loadingState" class="loading">Loading chapter content...</div>

        <!-- Workflow Stage Indicator -->
        <div class="workflow-stages" id="workflowStages" style="display: none;">
            <h2>Pipeline Progress</h2>
            <div class="stage-flow" id="stageFlow">
                <!-- Stages will be dynamically inserted -->
            </div>
        </div>

        <!-- Section 1: Extracted Concepts -->
        <div id="conceptsSection" class="content-section" style="display: none;">
            <h2>üìö Extracted Concepts</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalConcepts">0</div>
                    <div class="stat-label">Total Concepts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgImportance">0</div>
                    <div class="stat-label">Avg Importance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalMinutes">0</div>
                    <div class="stat-label">Total Teaching Time</div>
                </div>
            </div>
            <div class="table-container">
                <table class="concepts-table">
                    <thead>
                        <tr>
                            <th style="min-width: 150px;">Concept Name</th>
                            <th>Type</th>
                            <th>Difficulty</th>
                            <th>Importance</th>
                            <th>Time</th>
                            <th>Bloom's</th>
                            <th style="min-width: 120px;">Engagement</th>
                            <th style="min-width: 150px;">Exam Relevance</th>
                            <th style="min-width: 200px;">Misconceptions</th>
                            <th style="min-width: 150px;">Memory Hooks</th>
                            <th>Prerequisites</th>
                        </tr>
                    </thead>
                    <tbody id="conceptsTableBody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding: 16px; background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px;">
                <strong style="color: #1e40af;">üí° Understanding Concept Metadata:</strong>
                <ul style="margin: 8px 0 0 20px; color: #1e3a8a; font-size: 14px; line-height: 1.6;">
                    <li><strong>Engagement</strong>: Shows humor/story potential - how engaging this concept can be made</li>
                    <li><strong>Exam Relevance</strong>: Types of questions this concept typically appears in</li>
                    <li><strong>Misconceptions</strong>: Common mistakes students make - will be addressed in scripts</li>
                    <li><strong>Memory Hooks</strong>: Mnemonics, visual imagery, or tricks to help students remember</li>
                    <li><strong>Prerequisites</strong>: Concepts that should be understood before this one</li>
                </ul>
            </div>
        </div>

        <!-- Chapter Analysis - How AI Interpreted This Chapter -->
        <div id="chapterAnalysisSection" class="content-section" style="display: none;">
            <h2>AI Chapter Analysis</h2>
            <p style="font-size: 14px; color: var(--gray-600); margin-bottom: 16px;">
                Our AI analyzed this chapter to understand its pedagogical structure and determine the best way to group concepts into episodes for effective audio revision.
            </p>
            <div class="analysis-card">
                <div class="analysis-grid">
                    <div class="analysis-item">
                        <div class="analysis-label">Chapter Type</div>
                        <div class="analysis-value" id="chapterType">
                            <span class="badge" id="chapterTypeBadge">-</span>
                        </div>
                    </div>
                    <div class="analysis-item">
                        <div class="analysis-label">Grouping Strategy</div>
                        <div class="analysis-value" id="groupingStrategy">-</div>
                    </div>
                    <div class="analysis-item">
                        <div class="analysis-label">AI Confidence</div>
                        <div class="analysis-value" id="analysisConfidence">
                            <span class="confidence-bar"><span class="confidence-fill" id="confidenceFill"></span></span>
                            <span id="confidencePercent">-</span>
                        </div>
                    </div>
                </div>
                <div class="analysis-details">
                    <div class="detail-section">
                        <strong>Pedagogical Intent</strong>
                        <p id="pedagogicalIntent">-</p>
                    </div>
                    <div class="detail-section">
                        <strong>AI Reasoning</strong>
                        <p id="aiReasoning">-</p>
                    </div>
                    <div class="detail-section">
                        <strong>Grouping Rationale</strong>
                        <p id="groupingRationale">-</p>
                    </div>
                </div>
            </div>
            <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-left: 4px solid var(--primary); border-radius: 4px;">
                <p style="margin: 0; font-size: 13px; color: var(--gray-700);">
                    <strong>Why this matters:</strong> The chapter classification above determined how concepts were grouped into episodes below. This ensures pedagogically sound content structure for effective student revision.
                </p>
            </div>
        </div>

        <!-- Section 2: Episode Plan -->
        <div id="episodePlanSection" class="content-section" style="display: none;">
            <h2>üé¨ Episode Plan</h2>
            <div id="episodePlanActions" style="margin-bottom: 20px; padding: 16px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <strong style="color: #92400e; font-size: 16px;">‚ö†Ô∏è Plan Pending Approval</strong>
                        <p style="margin: 8px 0 0 0; color: #78350f; font-size: 14px;">
                            Review the episode plan below. Once approved, scripts will be generated for each episode.
                        </p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-success" onclick="approvePlan()" id="approvePlanBtn">
                            ‚úÖ Approve Plan & Generate Scripts
                        </button>
                        <button class="btn btn-secondary" onclick="requestPlanRevision()">
                            üîÑ Request Changes
                        </button>
                    </div>
                </div>
            </div>
            <div id="episodePlanContainer"></div>
        </div>

        <!-- Section 3: Scripts -->
        <div id="scriptsSection" class="content-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üìù Generated Scripts</h2>
                <div id="scriptsActions" style="display: none;">
                    <button class="btn btn-success" onclick="approveAll()" style="padding: 10px 20px;">
                        ‚úÖ Approve All Episodes
                    </button>
                </div>
            </div>
            <div id="scriptsContainer"></div>
        </div>

        <!-- Section 4: Voice Configuration -->
        <div id="voiceConfigSection" class="content-section" style="display: none;">
            <h2>üé§ Voice Configuration</h2>
            <p style="font-size: 14px; color: var(--gray-600); margin-bottom: 20px;">
                Choose voices for your two student speakers before generating audio
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                <div style="border: 2px solid var(--gray-200); border-radius: 12px; padding: 20px;">
                    <h3 style="margin-bottom: 16px; color: var(--gray-900);">Student 1</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 8px; color: var(--gray-700);">Name</label>
                        <input type="text" id="speaker1Name" value="Maya" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 8px; color: var(--gray-700);">Voice</label>
                        <select id="speaker1Voice" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 14px;">
                            <option value="">Loading voices...</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="testVoice(1)">
                        üîä Test Voice
                    </button>
                </div>

                <div style="border: 2px solid var(--gray-200); border-radius: 12px; padding: 20px;">
                    <h3 style="margin-bottom: 16px; color: var(--gray-900);">Student 2</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 8px; color: var(--gray-700);">Name</label>
                        <input type="text" id="speaker2Name" value="Arjun" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 8px; color: var(--gray-700);">Voice</label>
                        <select id="speaker2Voice" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 14px;">
                            <option value="">Loading voices...</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="testVoice(2)">
                        üîä Test Voice
                    </button>
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="generateAudio()">
                üéµ Generate Audio with Selected Voices
            </button>
        </div>
    </div>

    <script>
        let currentChapter = null;

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            let chapterId = params.get('chapter');
            
            if (!chapterId) {
                // No chapter ID - redirect to dashboard
                console.warn('No chapter ID provided, redirecting to dashboard');
                window.location.href = 'dashboard.html';
                return;
            }
            
            console.log('Loading chapter:', chapterId);
            loadChapterData(chapterId);
            loadVoices(); // Load voice options
        });

        async function loadChapterData(chapterId) {
            try {
                console.log('Fetching chapter:', `/api/v1/chapter/${chapterId}`);
                
                // Load chapter data and workflow status in parallel
                const [chapterRes, workflowRes] = await Promise.all([
                    fetch(`/api/v1/chapter/${chapterId}`),
                    fetch(`/api/v1/chapter/${chapterId}/workflow-status`)
                ]);
                
                if (!chapterRes.ok) throw new Error(`Failed to load chapter: ${chapterRes.status}`);
                
                currentChapter = await chapterRes.json();
                console.log('Loaded chapter:', currentChapter);
                
                // Load workflow status if available
                if (workflowRes.ok) {
                    const workflowStatus = await workflowRes.json();
                    console.log('Workflow status:', workflowStatus);
                    displayWorkflowStages(workflowStatus);
                    currentChapter.workflow_status = workflowStatus;
                } else {
                    console.warn('No workflow status available (old chapter format)');
                }
                
                displayChapter();
                
                // Resume job polling if still active
                await uiState.resumeActiveJob(
                    (status) => {
                        console.log('Job update:', status);
                        // Update workflow status in real-time
                        loadChapterData(chapterId);
                    },
                    (status, completedChapterId) => {
                        console.log('Job complete:', completedChapterId);
                        loadChapterData(chapterId);
                    },
                    (error) => {
                        console.error('Job error:', error);
                    }
                );
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('loadingState').textContent = 'Error: ' + e.message;
            }
        }

        function displayWorkflowStages(workflowStatus) {
            const stages = [
                { id: 'uploaded', label: 'Uploaded', icon: 'üì§', desc: 'Chapter received' },
                { id: 'extracting', label: 'Extracting', icon: 'üîç', desc: 'Reading content' },
                { id: 'extracted', label: 'Concepts', icon: 'üß†', desc: 'Concepts extracted' },
                { id: 'plan_generated', label: 'Plan Ready', icon: 'üìã', desc: 'Awaiting approval' },
                { id: 'plan_approved', label: 'Plan ‚úì', icon: '‚úÖ', desc: 'Plan approved' },
                { id: 'content_generating', label: 'Scripting', icon: '‚úçÔ∏è', desc: 'Generating scripts' },
                { id: 'content_generated', label: 'Scripts Ready', icon: 'üìù', desc: 'Awaiting approval' },
                { id: 'content_approved', label: 'Scripts ‚úì', icon: '‚úÖ', desc: 'Scripts approved' },
                { id: 'audio_generating', label: 'Audio', icon: 'üîä', desc: 'Creating audio' },
                { id: 'audio_complete', label: 'Ready', icon: 'üéß', desc: 'Ready to listen' }
            ];

            const currentStage = workflowStatus.current_stage;
            const currentIndex = stages.findIndex(s => s.id === currentStage);

            const stageHTML = stages.map((stage, index) => {
                let className = 'stage-box';
                if (index < currentIndex) className += ' completed';
                if (index === currentIndex) className += ' active';

                const connector = index < stages.length - 1 
                    ? `<span class="stage-connector ${index < currentIndex ? 'completed' : ''}">‚Üí</span>` 
                    : '';

                return `
                    <div class="${className}" title="${stage.desc}">
                        <div class="icon">${stage.icon}</div>
                        <div style="font-size: 12px; font-weight: 600;">${stage.label}</div>
                    </div>
                    ${connector}
                `;
            }).join('');

            document.getElementById('stageFlow').innerHTML = stageHTML;
            document.getElementById('workflowStages').style.display = 'block';
        }

        function displayChapter() {
            document.getElementById('chapterId').textContent = currentChapter.chapter_id || 'N/A';
            document.getElementById('chapterSubject').textContent = currentChapter.metadata?.subject || 'N/A';
            document.getElementById('chapterGrade').textContent = currentChapter.metadata?.grade_band || 'N/A';
            document.getElementById('episodeCount').textContent = currentChapter.episodes?.length || 0;
            
            document.getElementById('loadingState').style.display = 'none';
            
            displayChapterAnalysis();
            displayConcepts();
            displayEpisodePlan();
            displayScripts();
        }

        function displayChapterAnalysis() {
            const analysis = currentChapter.chapter_analysis;
            
            if (!analysis) {
                document.getElementById('chapterAnalysisSection').style.display = 'none';
                return;
            }

            document.getElementById('chapterAnalysisSection').style.display = 'block';
            
            // Content Type (open-ended, not predefined)
            const contentType = analysis.content_type || analysis.chapter_type || 'unknown';
            const typeBadge = document.getElementById('chapterTypeBadge');
            typeBadge.textContent = contentType.toUpperCase();
            typeBadge.className = `badge badge-primary`;
            
            // Episode Approach (LLM's recommendation)
            const approach = analysis.recommended_episode_approach || analysis.episode_grouping_strategy || 'N/A';
            document.getElementById('groupingStrategy').textContent = approach;
            
            // Confidence
            const confidence = analysis.confidence || 0;
            const confidencePercent = Math.round(confidence * 100);
            document.getElementById('confidencePercent').textContent = confidencePercent + '%';
            document.getElementById('confidenceFill').style.width = confidencePercent + '%';
            
            // Details (updated for open-ended analysis)
            const mainFocus = analysis.main_focus || analysis.pedagogical_intent || 'Not available';
            const reasoning = analysis.reasoning || 'Not available';
            const organization = analysis.content_organization || 'Not available';
            
            document.getElementById('pedagogicalIntent').textContent = mainFocus;
            document.getElementById('aiReasoning').textContent = reasoning;
            document.getElementById('groupingRationale').textContent = 
                `Organization: ${organization}\n${analysis.grouping_rationale || ''}`;
        }

        function displayConcepts() {
            const concepts = currentChapter.concepts || [];
            
            if (concepts.length === 0) {
                document.getElementById('conceptsSection').style.display = 'none';
                return;
            }

            document.getElementById('conceptsSection').style.display = 'block';
            
            const totalConcepts = concepts.length;
            const avgImportance = concepts.reduce((sum, c) => sum + (c.importance || 3), 0) / totalConcepts;
            const totalMinutes = concepts.reduce((sum, c) => sum + (c.estimated_minutes || 3), 0);
            
            document.getElementById('totalConcepts').textContent = totalConcepts;
            document.getElementById('avgImportance').textContent = avgImportance.toFixed(1);
            document.getElementById('totalMinutes').textContent = totalMinutes + ' min';
            
            const tbody = document.getElementById('conceptsTableBody');
            tbody.innerHTML = '';
            
            concepts.forEach(concept => {
                const row = document.createElement('tr');
                
                // Engagement badges
                const humorBadge = concept.humor_potential ? 
                    `<span class="badge badge-${concept.humor_potential === 'high' ? 'success' : concept.humor_potential === 'medium' ? 'warning' : 'secondary'}" style="font-size: 11px; margin: 2px;">üòÑ ${concept.humor_potential}</span>` : '';
                const storyBadge = concept.story_potential ? 
                    `<span class="badge badge-${concept.story_potential === 'high' ? 'success' : concept.story_potential === 'medium' ? 'warning' : 'secondary'}" style="font-size: 11px; margin: 2px;">üìñ ${concept.story_potential}</span>` : '';
                
                // Exam relevance
                const examTypes = Array.isArray(concept.exam_relevance) ? concept.exam_relevance.slice(0, 3).join(', ') : (concept.exam_relevance || 'N/A');
                const examMore = Array.isArray(concept.exam_relevance) && concept.exam_relevance.length > 3 ? ` <span style="color: #6b7280; font-size: 11px;">(+${concept.exam_relevance.length - 3})</span>` : '';
                
                // Misconceptions
                const misconceptions = Array.isArray(concept.common_misconceptions) && concept.common_misconceptions.length > 0 ? 
                    concept.common_misconceptions[0].substring(0, 50) + (concept.common_misconceptions[0].length > 50 ? '...' : '') : 'None';
                const miscCount = Array.isArray(concept.common_misconceptions) && concept.common_misconceptions.length > 1 ? ` <span style="color: #ef4444; font-weight: 600;">(+${concept.common_misconceptions.length - 1})</span>` : '';
                
                // Memory hooks
                const memoryHooks = concept.memory_hooks || 'None';
                
                // Prerequisites
                const prereqs = Array.isArray(concept.related) && concept.related.length > 0 ? 
                    concept.related.slice(0, 2).join(', ') : 'None';
                const prereqsMore = Array.isArray(concept.related) && concept.related.length > 2 ? ` <span style="color: #6b7280; font-size: 11px;">(+${concept.related.length - 2})</span>` : '';
                
                row.innerHTML = `
                    <td>
                        <strong>${concept.name || concept.id}</strong>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px; line-height: 1.4;">${(concept.definition || '').substring(0, 80)}${concept.definition && concept.definition.length > 80 ? '...' : ''}</div>
                    </td>
                    <td><span class="badge badge-${concept.type}">${concept.type || 'unknown'}</span></td>
                    <td><span class="badge badge-${concept.difficulty}">${concept.difficulty || 'medium'}</span></td>
                    <td>
                        <div class="importance-bar">
                            ${[1,2,3,4,5].map(i => 
                                `<div class="importance-dot ${i <= (concept.importance || 3) ? 'filled' : ''}"></div>`
                            ).join('')}
                            <span style="margin-left: 8px; font-weight: 600;">${concept.importance || 3}/5</span>
                        </div>
                    </td>
                    <td><strong>${concept.estimated_minutes || 3}</strong> min</td>
                    <td><span style="font-size: 13px;">${concept.blooms || 'understand'}</span></td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            ${humorBadge}
                            ${storyBadge}
                        </div>
                    </td>
                    <td style="font-size: 12px;">
                        <div style="color: #4b5563; line-height: 1.4;">${examTypes}${examMore}</div>
                    </td>
                    <td style="font-size: 12px;">
                        <div style="color: #ef4444; line-height: 1.4;">${misconceptions}${miscCount}</div>
                    </td>
                    <td style="font-size: 12px;">
                        <div style="color: #10b981; line-height: 1.4;">${memoryHooks}</div>
                    </td>
                    <td style="font-size: 12px;">
                        <div style="color: #6b7280; line-height: 1.4;">${prereqs}${prereqsMore}</div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayEpisodePlan() {
            const episodePlan = currentChapter.episode_plan || {};
            const episodes = episodePlan.episodes || [];
            
            if (episodes.length === 0) {
                document.getElementById('episodePlanSection').style.display = 'none';
                return;
            }

            document.getElementById('episodePlanSection').style.display = 'block';
            
            // Check if plan is already approved
            const workflowStatus = currentChapter.workflow_status;
            const isPlanApproved = workflowStatus?.stages?.planning?.status === 'approved' || 
                                   workflowStatus?.current_stage === 'plan_approved' ||
                                   workflowStatus?.current_stage === 'content_generating' ||
                                   workflowStatus?.current_stage === 'content_generated' ||
                                   workflowStatus?.current_stage === 'content_approved';
            
            // Show/hide approval actions based on plan status
            const actionsDiv = document.getElementById('episodePlanActions');
            if (actionsDiv) {
                actionsDiv.style.display = isPlanApproved ? 'none' : 'block';
            }
            
            const container = document.getElementById('episodePlanContainer');
            
            // Add plan overview summary with strategy information
            const totalDuration = episodes.reduce((sum, ep) => sum + ep.duration_minutes, 0);
            const totalConcepts = episodes.reduce((sum, ep) => sum + (ep.concept_details?.length || 0), 0);
            
            const planningMeta = episodePlan.planning_metadata || {};
            const strategyUsed = planningMeta.strategy_used || 'default';
            const strategyBadge = strategyUsed === 'llm_recommended_overview' ? 
                '<span class="badge badge-overview_introduction">üß† AI Overview Strategy</span>' :
                strategyUsed === 'llm_guided' ?
                '<span class="badge badge-topic_deepdive">üß† AI Guided</span>' :
                '<span class="badge badge-mixed">Default Strategy</span>';
            
            container.innerHTML = `
                <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0; color: #1e40af; font-size: 18px;">üìä Plan Overview</h3>
                        ${strategyBadge}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: #2563eb;">${episodes.length}</div>
                            <div style="color: #64748b; font-size: 14px;">Episodes Planned</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: #2563eb;">${totalDuration} min</div>
                            <div style="color: #64748b; font-size: 14px;">Total Duration</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: #2563eb;">${totalConcepts}</div>
                            <div style="color: #64748b; font-size: 14px;">Concepts Covered</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: #2563eb;">~${Math.round(totalDuration / episodes.length)} min</div>
                            <div style="color: #64748b; font-size: 14px;">Avg per Episode</div>
                        </div>
                    </div>
                </div>
            `;
            
            episodes.forEach((episode, idx) => {
                const card = document.createElement('div');
                card.className = 'episode-plan-card';
                
                const conceptDetails = episode.concept_details || [];
                
                // Calculate importance distribution
                const highImportance = conceptDetails.filter(c => c.importance >= 4).length;
                const mediumImportance = conceptDetails.filter(c => c.importance === 3).length;
                const lowImportance = conceptDetails.filter(c => c.importance <= 2).length;
                
                card.innerHTML = `
                    <div class="episode-plan-header">
                        <div>
                            <div class="episode-plan-title">üéôÔ∏è ${episode.title || `Episode ${episode.episode_number}`}</div>
                            <div style="color: #64748b; font-size: 13px; margin-top: 4px;">
                                ${episode.description || `Episode ${episode.episode_number} of ${episodes.length}`}
                            </div>
                        </div>
                        <div class="episode-duration">
                            <div style="font-size: 18px; font-weight: 700;">${episode.duration_minutes} min</div>
                            <div style="font-size: 12px; color: #64748b;">${episode.target_words} words</div>
                        </div>
                    </div>
                    
                    ${episode.rationale ? `
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 16px; margin: 16px 0; border-radius: 4px;">
                            <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">üìù Planning Rationale</div>
                            <div style="color: #78350f; font-size: 14px; line-height: 1.6;">${episode.rationale}</div>
                        </div>
                    ` : ''}
                    
                    <div style="margin: 16px 0;">
                        <div style="font-weight: 600; margin-bottom: 12px; font-size: 15px;">
                            üìö Content Coverage (${conceptDetails.length} concept${conceptDetails.length > 1 ? 's' : ''})
                        </div>
                        
                        ${highImportance > 0 || mediumImportance > 0 || lowImportance > 0 ? `
                            <div style="display: flex; gap: 12px; margin-bottom: 12px; font-size: 13px;">
                                ${highImportance > 0 ? `<span style="background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 12px; font-weight: 600;">‚≠ê‚≠ê‚≠ê High Priority: ${highImportance}</span>` : ''}
                                ${mediumImportance > 0 ? `<span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 12px; font-weight: 600;">‚≠ê‚≠ê Medium: ${mediumImportance}</span>` : ''}
                                ${lowImportance > 0 ? `<span style="background: #f1f5f9; color: #475569; padding: 4px 12px; border-radius: 12px; font-weight: 600;">‚≠ê Supporting: ${lowImportance}</span>` : ''}
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${conceptDetails.map((c, cidx) => `
                                <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: ${cidx % 2 === 0 ? '#f8fafc' : 'white'}; border-radius: 6px; border: 1px solid #e2e8f0;">
                                    <div style="min-width: 24px; height: 24px; background: ${c.importance >= 4 ? '#10b981' : c.importance >= 3 ? '#f59e0b' : '#94a3b8'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px;">
                                        ${cidx + 1}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 6px;">${c.name}</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 6px;">
                                            <span class="badge badge-${c.type}">${c.type}</span>
                                            <span class="badge badge-${c.difficulty}">${c.difficulty} difficulty</span>
                                            <span style="background: ${c.importance >= 4 ? '#dcfce7' : c.importance >= 3 ? '#fef3c7' : '#f1f5f9'}; color: ${c.importance >= 4 ? '#166534' : c.importance >= 3 ? '#92400e' : '#475569'}; padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">
                                                ${'‚≠ê'.repeat(c.importance)} Importance
                                            </span>
                                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">
                                                üïí ~${c.estimated_minutes} min
                                            </span>
                                        </div>
                                        ${c.description ? `<div style="color: #64748b; font-size: 13px; line-height: 1.5; margin-top: 4px;">${c.description}</div>` : ''}
                                        ${c.why_important ? `<div style="color: #7c3aed; font-size: 12px; font-style: italic; margin-top: 6px; padding-left: 12px; border-left: 2px solid #c4b5fd;">üí° ${c.why_important}</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 2px dashed #e2e8f0; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #64748b;">
                        <div>
                            <strong style="color: #1e293b;">Script Target:</strong> ${episode.word_count_range ? `${episode.word_count_range[0]}-${episode.word_count_range[1]}` : episode.target_words} words
                        </div>
                        <div>
                            <strong style="color: #1e293b;">Speaking Time:</strong> ~${Math.round(episode.duration_minutes * 60)} seconds at natural pace
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function displayScripts() {
            const episodes = currentChapter.episodes || [];
            
            if (episodes.length === 0) {
                document.getElementById('scriptsSection').style.display = 'none';
                document.getElementById('voiceConfigSection').style.display = 'none';
                return;
            }

            document.getElementById('scriptsSection').style.display = 'block';
            
            // Show voice config if scripts are generated
            const hasScripts = episodes.some(ep => ep.script_data && ep.script_data.sections);
            if (hasScripts) {
                document.getElementById('voiceConfigSection').style.display = 'block';
            }
            
            // Count unapproved episodes
            const workflowStatus = currentChapter.workflow_status;
            let unapprovedCount = 0;
            episodes.forEach((ep, idx) => {
                let episodeStatus = null;
                if (workflowStatus && workflowStatus.episodes) {
                    episodeStatus = workflowStatus.episodes.find(e => e.episode_number === (idx + 1));
                }
                const isApproved = episodeStatus?.status === 'approved';
                if (!isApproved) unapprovedCount++;
            });
            
            // Show "Approve All" button if there are unapproved episodes
            const scriptsActions = document.getElementById('scriptsActions');
            if (scriptsActions) {
                scriptsActions.style.display = unapprovedCount > 1 ? 'block' : 'none';
            }
            
            const container = document.getElementById('scriptsContainer');
            container.innerHTML = '';
            
            episodes.forEach((episode, idx) => {
                const script = episode.script_data || {};
                const sections = script.sections || [];
                
                const totalWords = sections.reduce((sum, s) => sum + (s.text || '').split(/\s+/).length, 0);
                const durationMinutes = Math.round((totalWords / 150) * 10) / 10;
                
                const validation = episode.validation || {};
                const validationPassed = validation.passed !== false;
                const validationErrors = validation.errors || [];
                
                // Get episode status from workflow if available
                const workflowStatus = currentChapter.workflow_status;
                let episodeStatus = null;
                if (workflowStatus && workflowStatus.episodes) {
                    episodeStatus = workflowStatus.episodes.find(ep => ep.episode_number === (idx + 1));
                }
                
                const isApproved = episodeStatus?.status === 'approved';
                const isPending = episodeStatus?.status === 'generated' || episodeStatus?.status === 'pending_review';
                
                const card = document.createElement('div');
                card.className = 'script-card';
                
                card.innerHTML = `
                    <div class="script-header">
                        <div>
                            <div class="script-title">${episode.title || `Episode ${idx + 1}`}</div>
                            ${episodeStatus ? `
                                <span class="status-badge ${episodeStatus.status}">${episodeStatus.status}</span>
                            ` : ''}
                            <div class="script-meta">
                                <div class="script-meta-item">
                                    <span>üìù</span> <strong>${totalWords}</strong> words
                                </div>
                                <div class="script-meta-item">
                                    <span>üïí</span> <strong>${durationMinutes}</strong> minutes
                                </div>
                                <div class="script-meta-item">
                                    <span>üìö</span> <strong>${sections.length}</strong> sections
                                </div>
                                ${validation.attempts ? `
                                    <div class="script-meta-item">
                                        <span>üîÑ</span> <strong>${validation.attempts}</strong> attempts
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="validation-status ${validationPassed ? 'validation-passed' : validationErrors.length > 0 ? 'validation-failed' : 'validation-warnings'}">
                            ${validationPassed ? '‚úì Validation Passed' : validationErrors.length > 0 ? '‚úó Validation Failed' : '‚ö† Has Warnings'}
                        </div>
                    </div>
                    
                    ${validationErrors.length > 0 ? `
                        <div class="validation-errors">
                            <strong>Validation Issues:</strong>
                            <ul>
                                ${validationErrors.map(err => `<li>${err}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="script-content">
                        ${sections.map(section => `
                            <div class="script-section">
                                ${section.speaker ? `<div class="script-speaker">${section.speaker}:</div>` : ''}
                                <div class="script-text">${section.text || ''}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="script-actions" style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
                        ${!isApproved ? `
                            <button class="btn btn-success" onclick="approveEpisode(${idx + 1})">
                                ‚úÖ Approve Episode ${idx + 1}
                            </button>
                            <button class="btn btn-secondary" onclick="showRevisionOptions(${idx + 1})">
                                üîÑ Request Revision
                            </button>
                        ` : `
                            <div style="color: var(--success); font-weight: 600;">
                                ‚úÖ Approved ${episodeStatus.approved_at ? `on ${new Date(episodeStatus.approved_at).toLocaleDateString()}` : ''}
                            </div>
                        `}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        async function approveEpisode(episodeNumber) {
            if (!currentChapter) return;
            
            if (!confirm(`Approve Episode ${episodeNumber}?`)) return;
            
            try {
                const chapterId = currentChapter.chapter_id;
                const res = await fetch(`/api/v1/chapter/${chapterId}/approve-episode/${episodeNumber}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ approved_by: 'teacher' })
                });
                
                if (!res.ok) {
                    throw new Error('Approval failed');
                }
                
                alert(`‚úÖ Episode ${episodeNumber} approved!`);
                location.reload();
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showRevisionOptions(episodeNumber) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            const revisionTypes = [
                { id: 'regen_natural_dialogue', label: 'üí¨ Make More Natural', desc: 'Improve conversation flow and naturalness' },
                { id: 'regen_engagement', label: 'üéâ Add More Engagement', desc: 'Add humor, examples, or stories' },
                { id: 'regen_clarity', label: 'üîç Simplify Explanation', desc: 'Make concepts clearer and easier to understand' },
                { id: 'regen_confusion', label: '‚ö†Ô∏è Address Confusions', desc: 'Better handle misconceptions' },
                { id: 'regen_pacing', label: '‚è±Ô∏è Adjust Pacing', desc: 'Change depth or speed of explanation' },
                { id: 'regen_depth', label: 'üìö Add More Depth', desc: 'Provide more detailed explanation' },
                { id: 'regen_examples', label: 'üåü Better Examples', desc: 'More relatable, age-appropriate examples' },
                { id: 'regen_tone', label: 'üé≠ Adjust Tone', desc: 'Make more/less formal, change personality' },
                { id: 'regen_memory_hooks', label: 'üß† Add Memory Tricks', desc: 'Add mnemonics or memory aids' },
                { id: 'regen_exam_focus', label: 'üìù Exam Emphasis', desc: 'Focus more on exam-relevant points' }
            ];
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin: 0 0 8px 0; color: #1e293b;">Request Revision for Episode ${episodeNumber}</h2>
                    <p style="color: #64748b; margin: 0 0 24px 0; font-size: 14px;">Select the type of improvement you'd like:</p>
                    
                    <div style="display: grid; gap: 12px;">
                        ${revisionTypes.map(type => `
                            <button class="revision-option" onclick="requestRevisionWithType(${episodeNumber}, '${type.id}', '${type.label}')" 
                                style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 16px; text-align: left; cursor: pointer; transition: all 0.2s;"
                                onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff';"
                                onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc';">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${type.label}</div>
                                <div style="font-size: 13px; color: #64748b;">${type.desc}</div>
                            </button>
                        `).join('')}
                        
                        <button onclick="requestCustomRevision(${episodeNumber})" 
                            style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 16px; text-align: left; cursor: pointer; font-weight: 600; color: #92400e; margin-top: 8px;"
                            onmouseover="this.style.background='#fde68a';"
                            onmouseout="this.style.background='#fef3c7';">
                            ‚úèÔ∏è Custom Feedback (describe in your own words)
                        </button>
                    </div>
                    
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" 
                        style="margin-top: 20px; width: 100%; padding: 12px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: #475569;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function requestRevisionWithType(episodeNumber, regenerationType, label) {
            // Close modal
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
            
            const additionalNotes = prompt(`You selected: ${label}\n\nAny additional notes for this revision? (Optional - press OK to continue)`);
            
            try {
                const chapterId = currentChapter.chapter_id;
                const res = await fetch(`/api/v1/chapter/${chapterId}/request-revision`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        episode_number: episodeNumber,
                        regeneration_type: regenerationType,
                        feedback: additionalNotes || label,
                        requested_by: 'teacher'
                    })
                });
                
                if (!res.ok) {
                    throw new Error('Failed to request revision');
                }
                
                alert(`‚úÖ Revision requested: ${label}\n\nThe script will be regenerated with your feedback.`);
                location.reload();
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function requestCustomRevision(episodeNumber) {
            // Close modal
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
            
            const feedback = prompt(`Custom revision request for Episode ${episodeNumber}.\n\nDescribe what you'd like changed:`);
            
            if (!feedback || !feedback.trim()) return;
            
            try {
                const chapterId = currentChapter.chapter_id;
                const res = await fetch(`/api/v1/chapter/${chapterId}/request-revision`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        episode_number: episodeNumber,
                        regeneration_type: 'custom',
                        feedback: feedback,
                        requested_by: 'teacher'
                    })
                });
                
                if (!res.ok) {
                    throw new Error('Failed to request revision');
                }
                
                alert(`‚úÖ Custom revision requested for Episode ${episodeNumber}`);
                location.reload();
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function requestRevision(episodeNumber) {
            // Legacy function - now redirects to new modal
            showRevisionOptions(episodeNumber);
        }

        // Global status bar functions
        function showGlobalStatus(message) {
            document.getElementById('globalStatus').classList.add('active');
            document.getElementById('globalStatusText').textContent = message;
        }

        function hideGlobalStatus() {
            document.getElementById('globalStatus').classList.remove('active');
        }

        function dismissGlobalStatus() {
            hideGlobalStatus();
        }

        // Check for active job and show status
        async function checkActiveJob() {
            const activeJob = sessionStorage.getItem('activeJob');
            if (activeJob) {
                try {
                    const { jobId, chapterId, startTime } = JSON.parse(activeJob);
                    const elapsed = Date.now() - startTime;
                    
                    if (elapsed < 30 * 60 * 1000) {
                        showGlobalStatus(`‚öôÔ∏è Generating content... (Chapter: ${chapterId})`);
                        
                        // Poll status in background
                        const pollStatus = async () => {
                            try {
                                const res = await fetch(`/api/v1/status/${jobId}`);
                                if (res.ok) {
                                    const s = await res.json();
                                    if (s.status === 'completed') {
                                        sessionStorage.removeItem('activeJob');
                                        showGlobalStatus(`‚úÖ Generation complete! Chapter: ${chapterId}`);
                                        // Auto-refresh if we're on this chapter's page
                                        const params = new URLSearchParams(window.location.search);
                                        if (params.get('chapter') === chapterId) {
                                            setTimeout(() => loadChapterData(chapterId), 1000);
                                        }
                                    } else if (s.status === 'failed') {
                                        sessionStorage.removeItem('activeJob');
                                        showGlobalStatus(`‚ùå Generation failed for chapter: ${chapterId}`);
                                    } else if (s.status === 'processing' || s.status === 'pending') {
                                        const progress = s.progress || 0;
                                        showGlobalStatus(`‚öôÔ∏è Generating... ${progress}% (Chapter: ${chapterId})`);
                                        setTimeout(pollStatus, 5000);
                                    }
                                } else {
                                    sessionStorage.removeItem('activeJob');
                                    hideGlobalStatus();
                                }
                            } catch (e) {
                                console.error('Failed to check job status:', e);
                            }
                        };
                        
                        pollStatus();
                    } else {
                        sessionStorage.removeItem('activeJob');
                    }
                } catch (e) {
                    console.error('Failed to parse active job:', e);
                    sessionStorage.removeItem('activeJob');
                }
            }
        }

        async function loadChapter() {
            const params = new URLSearchParams(window.location.search);
            const chapterId = params.get('chapter');
            if (chapterId) loadChapterData(chapterId);
            checkActiveJob(); // Check for background generation
        }

        async function approveAll() {
            if (!currentChapter || !currentChapter.episodes) {
                alert('No episodes to approve');
                return;
            }

            if (!confirm(`Approve all ${currentChapter.episodes.length} episodes?`)) {
                return;
            }

            try {
                const chapterId = currentChapter.chapter_id;
                
                // Approve each episode
                for (let i = 0; i < currentChapter.episodes.length; i++) {
                    const episodeNum = i + 1;
                    const res = await fetch(`/api/v1/chapter/${chapterId}/approve-episode/${episodeNum}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ approved_by: 'teacher' })
                    });
                    
                    if (!res.ok) {
                        throw new Error(`Failed to approve episode ${episodeNum}`);
                    }
                }
                
                alert(`‚úÖ All ${currentChapter.episodes.length} episodes approved!`);
                
                // Reload to show updated status
                location.reload();
                
            } catch (error) {
                alert('Error approving episodes: ' + error.message);
            }
        }

        async function generateAudio() {
            if (!currentChapter) {
                alert('No chapter loaded');
                return;
            }

            // Get selected voices
            const speaker1Name = document.getElementById('speaker1Name').value || 'Maya';
            const speaker2Name = document.getElementById('speaker2Name').value || 'Arjun';
            const speaker1Voice = document.getElementById('speaker1Voice').value;
            const speaker2Voice = document.getElementById('speaker2Voice').value;

            if (!speaker1Voice || !speaker2Voice) {
                alert('Please select voices for both speakers');
                return;
            }

            if (!confirm(`Generate audio with:\n\n${speaker1Name}: ${speaker1Voice}\n${speaker2Name}: ${speaker2Voice}\n\nThis may take several minutes.`)) {
                return;
            }

            try {
                const chapterId = currentChapter.chapter_id;
                const res = await fetch('/api/v1/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chapter_id: chapterId,
                        batch_mode: true,
                        voice_config: {
                            speaker1_name: speaker1Name,
                            speaker2_name: speaker2Name,
                            speaker1_voice: speaker1Voice,
                            speaker2_voice: speaker2Voice
                        }
                    })
                });

                if (!res.ok) {
                    throw new Error('Audio generation failed');
                }

                const result = await res.json();
                alert(`‚úÖ Audio generation started! Job ID: ${result.job_id}`);
                
                // Start polling for audio generation status
                if (result.job_id) {
                    uiState.setActiveJob(result.job_id, chapterId);
                    pollAudioGeneration(result.job_id, chapterId);
                }

            } catch (error) {
                alert('Error generating audio: ' + error.message);
            }
        }

        async function pollAudioGeneration(jobId, chapterId) {
            const poll = async () => {
                try {
                    const res = await fetch(`/api/v1/status/${jobId}`);
                    if (!res.ok) return;
                    
                    const status = await res.json();
                    
                    if (status.status === 'completed') {
                        uiState.clearActiveJob();
                        alert('‚úÖ Audio generation complete!');
                        location.reload();
                    } else if (status.status === 'failed') {
                        uiState.clearActiveJob();
                        alert('‚ùå Audio generation failed: ' + (status.error || 'Unknown error'));
                    } else {
                        // Still processing, check again in 5 seconds
                        setTimeout(poll, 5000);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            };
            
            poll();
        }

        async function approvePlan() {
            if (!currentChapter) {
                alert('No chapter loaded');
                return;
            }

            if (!confirm('Approve this episode plan and start script generation?\n\nThis will begin generating scripts for all episodes.')) {
                return;
            }

            try {
                const chapterId = currentChapter.chapter_id;
                const res = await fetch(`/api/v1/chapter/${chapterId}/approve-plan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ approved_by: 'teacher' })
                });

                if (!res.ok) {
                    throw new Error('Plan approval failed');
                }

                alert('‚úÖ Plan approved! Script generation will begin automatically.');
                
                // Hide approval actions
                const actionsDiv = document.getElementById('episodePlanActions');
                if (actionsDiv) {
                    actionsDiv.style.display = 'none';
                }
                
                // Reload to show updated status
                setTimeout(() => location.reload(), 1500);

            } catch (error) {
                alert('Error approving plan: ' + error.message);
            }
        }

        async function requestPlanRevision() {
            const feedback = prompt('What changes would you like to make to the episode plan?\n\nDescribe your requirements:');
            
            if (!feedback || !feedback.trim()) return;

            try {
                const chapterId = currentChapter.chapter_id;
                const res = await fetch(`/api/v1/chapter/${chapterId}/request-revision`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        revision_type: 'plan',
                        revision_notes: feedback,
                        requested_by: 'teacher'
                    })
                });

                if (!res.ok) {
                    throw new Error('Failed to request revision');
                }

                alert('‚úÖ Revision request recorded. The plan will be regenerated with your feedback.');
                
            } catch (error) {
                alert('Error requesting revision: ' + error.message);
            }
        }

        async function loadVoices() {
            try {
                const res = await fetch('/api/v1/voices');
                if (!res.ok) throw new Error('Failed to load voices');
                
                const voices = await res.json();
                const select1 = document.getElementById('speaker1Voice');
                const select2 = document.getElementById('speaker2Voice');
                
                // Filter for conversational/expressive voices
                const goodVoices = voices.filter(v => 
                    v.name.includes('Chirp3-HD') || 
                    v.name.includes('Studio') || 
                    v.name.includes('Neural2')
                );
                
                select1.innerHTML = goodVoices.map(v => 
                    `<option value="${v.name}">${v.name} (${v.languageCodes[0]})</option>`
                ).join('');
                
                select2.innerHTML = goodVoices.map(v => 
                    `<option value="${v.name}">${v.name} (${v.languageCodes[0]})</option>`
                ).join('');
                
                // Set defaults
                select1.value = 'en-IN-Chirp3-HD-Aoede';
                select2.value = 'en-IN-Chirp3-HD-Achird';
                
            } catch (error) {
                console.error('Failed to load voices:', error);
            }
        }

        async function testVoice(speakerNum) {
            const voiceSelect = document.getElementById(`speaker${speakerNum}Voice`);
            const nameInput = document.getElementById(`speaker${speakerNum}Name`);
            const voice = voiceSelect.value;
            const name = nameInput.value || `Speaker ${speakerNum}`;
            
            if (!voice) {
                alert('Please select a voice first');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Generating...';
            
            try {
                const res = await fetch('/api/v1/test-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        voice: voice,
                        text: `Hi, I'm ${name}! Let's explore this chapter together and make learning fun!`
                    })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.audio_url) {
                        btn.textContent = 'Playing...';
                        const audio = new Audio(data.audio_url);
                        audio.play();
                        audio.onended = () => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                        };
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }, 10000);
                    }
                } else {
                    throw new Error('Voice test failed');
                }
            } catch (error) {
                btn.textContent = 'Failed';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }
    </script>
</body>
</html>
