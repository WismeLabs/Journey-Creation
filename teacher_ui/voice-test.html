<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Preview - Journey Creation</title>
    <meta http-equiv="refresh" content="0; url=https://cloud.google.com/text-to-speech/docs/voices">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .speaker-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .speaker-config {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            background: #fafafa;
        }

        .nav-bar {
            background: #2c3e50;
            padding: 0;
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 20px;
        }

        .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 15px 25px;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-bar a:hover {
            background: #34495e;
        }

        .nav-bar a.active {
            background: #34495e;
            border-bottom-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="upload.html">üì§ Upload Chapter</a>
        <a href="voice-config.html">üé§ Voice Settings</a>
        <a href="voice-test.html" class="active">üß™ Test Voices</a>
        <a href="review.html">üìù Review Content</a>
        <a href="logs.html">üìä System Logs</a>
    </div>
    
    <div class="container">
        <h1>üé§ Voice Configuration Test</h1>
        <p>Test the voice configuration API and speaker name customization functionality.</p>

        <!-- Quick API Tests -->
        <div class="test-section">
            <h3>üîß API Connection Tests</h3>
            <button onclick="testConnection()">Test Server Connection</button>
            <button onclick="loadVoices()">Load Available Voices</button>
            <button onclick="getCurrentConfig()">Get Current Configuration</button>
            <div id="apiResults" class="result"></div>
        </div>

        <!-- Speaker Configuration -->
        <div class="test-section">
            <h3>üë• Speaker Configuration</h3>
            <div class="speaker-form">
                <div class="speaker-config">
                    <h4>Speaker 1</h4>
                    <label>Name:</label>
                    <input type="text" id="speaker1Name" value="Sarah" placeholder="Enter speaker name">
                    <label>Role:</label>
                    <select id="speaker1Role">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="narrator">Narrator</option>
                    </select>
                    <label>Voice:</label>
                    <select id="speaker1Voice">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="speaker-config">
                    <h4>Speaker 2</h4>
                    <label>Name:</label>
                    <input type="text" id="speaker2Name" value="Alex" placeholder="Enter speaker name">
                    <label>Role:</label>
                    <select id="speaker2Role">
                        <option value="student" selected>Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="co-host">Co-host</option>
                    </select>
                    <label>Voice:</label>
                    <select id="speaker2Voice">
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
            <button onclick="saveConfiguration()">üíæ Save Configuration</button>
            <button onclick="previewVoices()">üîä Preview Voices</button>
            <div id="configResults" class="result"></div>
        </div>

        <!-- Voice Preview -->
        <div class="test-section">
            <h3>üéµ Voice Preview Test</h3>
            <label>Preview Text:</label>
            <input type="text" id="previewText" value="Hello! This is how I'll sound in your educational episodes." placeholder="Enter text to preview">
            <button onclick="testVoicePreview()">Generate Voice Preview</button>
            <div id="previewResults" class="result"></div>
            <audio id="previewAudio" controls style="width: 100%; margin-top: 10px; display: none;"></audio>
        </div>

        <!-- Full Test -->
        <div class="test-section">
            <h3>üöÄ Full Integration Test</h3>
            <p>Test complete voice configuration with sample episode generation</p>
            <button onclick="runFullTest()">Run Complete Test</button>
            <div id="fullTestResults" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/tts';
        
        // Test basic server connection
        async function testConnection() {
            showResult('apiResults', 'Testing server connection...', 'info');
            try {
                const response = await fetch('/api/v1/tts/config');
                if (response.ok) {
                    showResult('apiResults', '‚úÖ Server connection successful!', 'success');
                } else {
                    showResult('apiResults', `‚ùå Server responded with status: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('apiResults', `‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        // Load available voices
        async function loadVoices() {
            showResult('apiResults', 'Loading available voices...', 'info');
            try {
                const response = await fetch('/api/v1/tts/voices');
                if (response.ok) {
                    const data = await response.json();
                    populateVoiceSelects(data);
                    showResult('apiResults', `‚úÖ Loaded ${Object.keys(data.available).length} voice categories`, 'success');
                } else {
                    showResult('apiResults', `‚ùå Failed to load voices: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('apiResults', `‚ùå Voice loading failed: ${error.message}`, 'error');
            }
        }

        // Get current configuration
        async function getCurrentConfig() {
            showResult('apiResults', 'Loading current configuration...', 'info');
            try {
                const response = await fetch('/api/v1/tts/config');
                if (response.ok) {
                    const config = await response.json();
                    showResult('apiResults', `‚úÖ Current config loaded:\n${JSON.stringify(config, null, 2)}`, 'success');
                } else {
                    showResult('apiResults', `‚ùå Failed to load config: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('apiResults', `‚ùå Config loading failed: ${error.message}`, 'error');
            }
        }

        // Save configuration
        async function saveConfiguration() {
            const config = gatherConfiguration();
            showResult('configResults', 'Saving configuration...', 'info');
            
            try {
                const response = await fetch('/api/v1/tts/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showResult('configResults', '‚úÖ Configuration saved successfully!\n' + JSON.stringify(result, null, 2), 'success');
                } else {
                    const error = await response.json();
                    showResult('configResults', `‚ùå Save failed: ${error.error}\nIssues: ${error.issues?.join(', ')}`, 'error');
                }
            } catch (error) {
                showResult('configResults', `‚ùå Save failed: ${error.message}`, 'error');
            }
        }

        // Preview voices
        async function previewVoices() {
            const speaker1Voice = document.getElementById('speaker1Voice').value;
            const speaker2Voice = document.getElementById('speaker2Voice').value;
            
            if (!speaker1Voice || !speaker2Voice) {
                showResult('configResults', '‚ùå Please select voices for both speakers first', 'error');
                return;
            }
            
            showResult('configResults', 'Generating voice previews...', 'info');
            
            try {
                // Preview speaker 1
                const preview1Text = `Hi, I'm ${document.getElementById('speaker1Name').value}. I'll be your guide in this educational journey.`;
                await generatePreview(speaker1Voice, preview1Text, 'Speaker 1');
                
                // Preview speaker 2  
                const preview2Text = `Hello! I'm ${document.getElementById('speaker2Name').value}. I'm excited to learn alongside you!`;
                await generatePreview(speaker2Voice, preview2Text, 'Speaker 2');
                
                showResult('configResults', '‚úÖ Voice previews generated! Check audio elements above.', 'success');
            } catch (error) {
                showResult('configResults', `‚ùå Preview failed: ${error.message}`, 'error');
            }
        }

        // Test voice preview
        async function testVoicePreview() {
            const text = document.getElementById('previewText').value;
            const voice = document.getElementById('speaker1Voice').value;
            
            if (!text || !voice) {
                showResult('previewResults', '‚ùå Please enter text and select a voice', 'error');
                return;
            }
            
            showResult('previewResults', 'Generating voice preview...', 'info');
            
            try {
                const response = await fetch('/api/v1/tts/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        voice: voice,
                        text: text,
                        speakingRate: 1.0,
                        pitch: 0,
                        volumeGain: 0
                    })
                });
                
                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioElement = document.getElementById('previewAudio');
                    audioElement.src = audioUrl;
                    audioElement.style.display = 'block';
                    audioElement.play();
                    showResult('previewResults', '‚úÖ Voice preview generated! Playing audio...', 'success');
                } else {
                    showResult('previewResults', `‚ùå Preview failed: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('previewResults', `‚ùå Preview failed: ${error.message}`, 'error');
            }
        }

        // Run full integration test
        async function runFullTest() {
            const config = gatherConfiguration();
            showResult('fullTestResults', 'Running full integration test...', 'info');
            
            // Test script must be array of {speaker, text} objects
            const testScript = [
                {
                    speaker: 'StudentA',
                    text: 'Welcome to our educational episode! Today we will explore fascinating concepts together.'
                },
                {
                    speaker: 'StudentB',
                    text: 'That sounds exciting! I am curious to learn more about this topic.'
                }
            ];
            
            try {
                const response = await fetch('/api/v1/tts/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config: config,
                        testScript: testScript
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showResult('fullTestResults', `‚úÖ Full test completed successfully!\nAudio: ${result.audio_url}`, 'success');
                    
                    // Play the audio
                    if (result.audio_url) {
                        const audio = new Audio(result.audio_url);
                        audio.play();
                    }
                } else {
                    const error = await response.json();
                    showResult('fullTestResults', `‚ùå Full test failed: ${error.error}`, 'error');
                }
            } catch (error) {
                showResult('fullTestResults', `‚ùå Full test failed: ${error.message}`, 'error');
            }
        }

        // Helper functions
        function gatherConfiguration() {
            return {
                speakers: {
                    speaker1: {
                        name: document.getElementById('speaker1Name').value,
                        role: document.getElementById('speaker1Role').value,
                        personality: 'confident',
                        voice: document.getElementById('speaker1Voice').value
                    },
                    speaker2: {
                        name: document.getElementById('speaker2Name').value,
                        role: document.getElementById('speaker2Role').value,
                        personality: 'curious',
                        voice: document.getElementById('speaker2Voice').value
                    }
                },
                audio: {
                    speakingRate: 1.0,
                    pitch: 0,
                    volumeGain: 0,
                    audioEncoding: 'MP3',
                    sampleRate: 44100,
                    effectsProfile: 'headphone-class-device'
                }
            };
        }

        function populateVoiceSelects(voiceData) {
            const select1 = document.getElementById('speaker1Voice');
            const select2 = document.getElementById('speaker2Voice');
            
            // Clear existing options
            select1.innerHTML = '';
            select2.innerHTML = '';
            
            // Add voice options from available voices
            // Structure: voiceData.available = { chirp3_hd: { 'en-US': [...], 'en-IN': [...] }, neural2: {...} }
            if (voiceData.available) {
                Object.keys(voiceData.available).forEach(voiceType => {
                    const languages = voiceData.available[voiceType];
                    
                    // Add optgroup for each voice type
                    const group1 = document.createElement('optgroup');
                    group1.label = voiceType.replace('_', ' ').toUpperCase();
                    const group2 = document.createElement('optgroup');
                    group2.label = voiceType.replace('_', ' ').toUpperCase();
                    
                    // Get voices for all languages
                    Object.keys(languages).forEach(lang => {
                        languages[lang].forEach(voiceName => {
                            const option1 = document.createElement('option');
                            option1.value = voiceName;
                            option1.textContent = voiceName;
                            group1.appendChild(option1);
                            
                            const option2 = document.createElement('option');
                            option2.value = voiceName;
                            option2.textContent = voiceName;
                            group2.appendChild(option2);
                        });
                    });
                    
                    select1.appendChild(group1);
                    select2.appendChild(group2);
                });
                
                // Set current voices if available
                if (voiceData.current && voiceData.current.speakers) {
                    select1.value = voiceData.current.speakers.StudentA.name;
                    select2.value = voiceData.current.speakers.StudentB.name;
                }
            }
        }

        async function generatePreview(voice, text, label) {
            try {
                const response = await fetch('/api/v1/tts/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        voice: voice,
                        text: text,
                        speakingRate: 1.0,
                        pitch: 0,
                        volumeGain: 0
                    })
                });
                
                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Create or update audio element for this speaker
                    const audioId = `preview${label.replace(' ', '')}Audio`;
                    let audioElement = document.getElementById(audioId);
                    
                    if (!audioElement) {
                        audioElement = document.createElement('audio');
                        audioElement.id = audioId;
                        audioElement.controls = true;
                        audioElement.style.width = '100%';
                        audioElement.style.marginTop = '10px';
                        document.getElementById('configResults').appendChild(audioElement);
                    }
                    
                    audioElement.src = audioUrl;
                    audioElement.play();
                    console.log(`‚úÖ Preview generated for ${label}: ${voice}`);
                } else {
                    throw new Error(`Preview failed with status ${response.status}`);
                }
            } catch (error) {
                console.error(`Failed to generate preview for ${label}:`, error);
                throw error;
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadVoices();
        });
    </script>
</body>
</html>